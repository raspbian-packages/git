From: Markus Koschany <apo@debian.org>
Date: Sun, 27 Aug 2017 19:31:07 +0200
Subject: 0026-CVE-2017-1000117.diff

---
 cache.h   | 8 ++++++++
 connect.c | 7 +++++++
 path.c    | 6 ++++++
 tcp.c     | 5 +++++
 4 files changed, 26 insertions(+)

diff --git a/cache.h b/cache.h
index 84b8229..eea30d0 100644
--- a/cache.h
+++ b/cache.h
@@ -766,6 +766,14 @@ int longest_ancestor_length(const char *path, const char *prefix_list);
 char *strip_path_suffix(const char *path, const char *suffix);
 int daemon_avoid_alias(const char *path);
 int offset_1st_component(const char *path);
+/*
+ * Returns true iff "str" could be confused as a command-line option when
+ * passed to a sub-program like "ssh". Note that this has nothing to do with
+ * shell-quoting, which should be handled separately; we're assuming here that
+ * the string makes it verbatim to the sub-program.
+ */
+int looks_like_command_line_option(const char *str);
+
 
 /* object replacement */
 #define READ_SHA1_FILE_REPLACE 1
diff --git a/connect.c b/connect.c
index 2d99852..4551a7a 100644
--- a/connect.c
+++ b/connect.c
@@ -309,6 +309,9 @@ struct child_process *git_connect(int fd[2], const char *url_orig,
 
 	conn = xcalloc(1, sizeof(*conn));
 
+	if (looks_like_command_line_option(path))
+		die("strange pathname '%s' blocked", path);
+
 	strbuf_init(&cmd, MAX_CMD_LEN);
 	strbuf_addstr(&cmd, prog);
 	strbuf_addch(&cmd, ' ');
@@ -321,6 +324,10 @@ struct child_process *git_connect(int fd[2], const char *url_orig,
 	if (protocol == PROTO_SSH) {
 		const char *ssh = getenv("GIT_SSH");
 		int putty = ssh && strcasestr(ssh, "plink");
+
+		if (looks_like_command_line_option(host))
+			die("strange hostname '%s' blocked", host);
+
 		if (!ssh) ssh = "ssh";
 		connect_transport_check_allowed("ssh");
 
diff --git a/path.c b/path.c
index 6f2aa69..7a58c78 100644
--- a/path.c
+++ b/path.c
@@ -667,3 +667,9 @@ int offset_1st_component(const char *path)
 		return 2 + is_dir_sep(path[2]);
 	return is_dir_sep(path[0]);
 }
+
+int looks_like_command_line_option(const char *str)
+{
+	return str && str[0] == '-';
+}
+
diff --git a/tcp.c b/tcp.c
index c27a0d7..561327e 100644
--- a/tcp.c
+++ b/tcp.c
@@ -244,6 +244,11 @@ struct child_process *git_proxy_connect(int fd[2], char *host)
 
 	get_host_and_port(&host, &port);
 
+	if (looks_like_command_line_option(host))
+		die("strange hostname '%s' blocked", host);
+	if (looks_like_command_line_option(port))
+		die("strange port '%s' blocked", port);
+
 	argv = xmalloc(sizeof(*argv) * 4);
 	argv[0] = git_proxy_command;
 	argv[1] = host;
