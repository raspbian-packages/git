From b258116462399b318c86165c61a5c7123043cfd4 Mon Sep 17 00:00:00 2001
From: Blake Burkhart <bburky@bburky.com>
Date: Tue, 22 Sep 2015 18:06:20 -0400
Subject: [PATCH] http: limit redirection depth

By default, libcurl will follow circular http redirects
forever. Let's put a cap on this so that somebody who can
trigger an automated fetch of an arbitrary repository (e.g.,
for CI) cannot convince git to loop infinitely.

The value chosen is 20, which is the same default that
Firefox uses.

Signed-off-by: Jeff King <peff@peff.net>
Signed-off-by: Junio C Hamano <gitster@pobox.com>
---
 http.c                        | 1 +
 t/lib-httpd/apache.conf       | 3 +++
 t/t5812-proto-disable-http.sh | 4 ++++
 3 files changed, 8 insertions(+)

Index: git-1.7.9.5/http.c
===================================================================
--- git-1.7.9.5.orig/http.c	2015-12-14 12:41:16.704882808 -0500
+++ git-1.7.9.5/http.c	2015-12-14 12:41:16.700882762 -0500
@@ -321,6 +321,7 @@
 	}
 
 	curl_easy_setopt(result, CURLOPT_FOLLOWLOCATION, 1);
+	curl_easy_setopt(result, CURLOPT_MAXREDIRS, 20);
 #if LIBCURL_VERSION_NUM >= 0x071301
 	curl_easy_setopt(result, CURLOPT_POSTREDIR, CURL_REDIR_POST_ALL);
 #elif LIBCURL_VERSION_NUM >= 0x071101
Index: git-1.7.9.5/t/lib-httpd/apache.conf
===================================================================
--- git-1.7.9.5.orig/t/lib-httpd/apache.conf	2015-12-14 12:41:16.704882808 -0500
+++ git-1.7.9.5/t/lib-httpd/apache.conf	2015-12-14 12:41:16.700882762 -0500
@@ -73,6 +73,9 @@
 RewriteRule ^/smart-redir-temp/(.*)$ /smart/$1 [R=302]
 RewriteRule ^/ftp-redir/(.*)$ ftp://localhost:1000/$1 [R=302]
 
+RewriteRule ^/loop-redir/x-x-x-x-x-x-x-x-x-x-x-x-x-x-x-x-x-x-x-x-(.*) /$1 [R=302]
+RewriteRule ^/loop-redir/(.*)$ /loop-redir/x-$1 [R=302]
+
 <IfDefine SSL>
 LoadModule ssl_module modules/mod_ssl.so
 
Index: git-1.7.9.5/t/t5812-proto-disable-http.sh
===================================================================
--- git-1.7.9.5.orig/t/t5812-proto-disable-http.sh	2015-12-14 12:41:16.704882808 -0500
+++ git-1.7.9.5/t/t5812-proto-disable-http.sh	2015-12-14 12:41:16.700882762 -0500
@@ -25,5 +25,9 @@
 	}
 '
 
+test_expect_success 'curl limits redirects' '
+	test_must_fail git clone "$HTTPD_URL/loop-redir/smart/repo.git"
+'
+
 stop_httpd
 test_done
