From 33ab122e87427bfad02fdee50564c2e2a4377067 Mon Sep 17 00:00:00 2001
From: Johannes Schindelin <johannes.schindelin@gmx.de>
Date: Thu, 19 Sep 2019 17:05:21 +0200
Subject: mingw: detect when MSYS2's sh is to be spawned more robustly

Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
(cherry picked from commit e2ba3d6f6d1c2b0e7e501ae01a0e839a6f537188)
Signed-off-by: Jonathan Nieder <jrnieder@gmail.com>
---
 compat/mingw.c | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/compat/mingw.c b/compat/mingw.c
index b4988d46fa..d0add1b18c 100644
--- a/compat/mingw.c
+++ b/compat/mingw.c
@@ -1395,7 +1395,10 @@ static inline int match_last_path_component(const char *path, size_t *len,
 
 static int is_msys2_sh(const char *cmd)
 {
-	if (cmd && !strcmp(cmd, "sh")) {
+	if (!cmd)
+		return 0;
+
+	if (!strcmp(cmd, "sh")) {
 		static int ret = -1;
 		char *p;
 
@@ -1415,6 +1418,16 @@ static int is_msys2_sh(const char *cmd)
 		}
 		return ret;
 	}
+
+	if (ends_with(cmd, "\\sh.exe")) {
+		static char *sh;
+
+		if (!sh)
+			sh = path_lookup("sh", 0);
+
+		return !fspathcmp(cmd, sh);
+	}
+
 	return 0;
 }
 
-- 
2.24.0.393.g34dc348eaf

