Origin: https://github.com/git/git/commit/f8d510ed0b357787c8d035d64f240bd82b424dc4
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2022-12-12

From f8d510ed0b357787c8d035d64f240bd82b424dc4 Mon Sep 17 00:00:00 2001
From: Taylor Blau <me@ttaylorr.com>
Date: Fri, 29 Jul 2022 15:20:28 -0400
Subject: [PATCH] t/t3NNN: allow local submodules

To prepare for the default value of `protocol.file.allow` to change to
"user", ensure tests that rely on local submodules can initialize them
over the file protocol.

Tests that only need to interact with submodules in a limited capacity
have individual Git commands annotated with the appropriate
configuration via `-c`. Tests that interact with submodules a handful of
times use `test_config_global` instead. Test scripts that rely on
submodules throughout use a `git config --global` during a setup test
towards the beginning of the script.

Signed-off-by: Taylor Blau <me@ttaylorr.com>
---
 t/t3200-branch.sh                | 1 +
 t/t3420-rebase-autostash.sh      | 2 +-
 t/t3426-rebase-submodule.sh      | 3 ++-
 t/t3512-cherry-pick-submodule.sh | 2 ++
 t/t3600-rm.sh                    | 3 ++-
 t/t3906-stash-submodule.sh       | 2 +-
 6 files changed, 9 insertions(+), 4 deletions(-)

Index: git-2.20.1/t/t3420-rebase-autostash.sh
===================================================================
--- git-2.20.1.orig/t/t3420-rebase-autostash.sh
+++ git-2.20.1/t/t3420-rebase-autostash.sh
@@ -354,7 +354,7 @@ test_expect_success 'autostash is saved
 test_expect_success 'autostash with dirty submodules' '
 	test_when_finished "git reset --hard && git checkout master" &&
 	git checkout -b with-submodule &&
-	git submodule add ./ sub &&
+	git -c protocol.file.allow=always submodule add ./ sub &&
 	test_tick &&
 	git commit -m add-submodule &&
 	echo changed >sub/file0 &&
Index: git-2.20.1/t/t3426-rebase-submodule.sh
===================================================================
--- git-2.20.1.orig/t/t3426-rebase-submodule.sh
+++ git-2.20.1/t/t3426-rebase-submodule.sh
@@ -45,7 +45,8 @@ test_expect_success 'rebase interactive
 	git init sub &&
 	git -C sub commit --allow-empty -m "Initial commit" &&
 	git init super &&
-	git -C super submodule add ../sub &&
+	git -c protocol.file.allow=always \
+		-C super submodule add ../sub &&
 	git -C super config submodule.sub.ignore dirty &&
 	>super/foo &&
 	git -C super add foo &&
Index: git-2.20.1/t/t3512-cherry-pick-submodule.sh
===================================================================
--- git-2.20.1.orig/t/t3512-cherry-pick-submodule.sh
+++ git-2.20.1/t/t3512-cherry-pick-submodule.sh
@@ -10,6 +10,8 @@ KNOWN_FAILURE_NOFF_MERGE_ATTEMPTS_TO_MER
 test_submodule_switch "git cherry-pick"
 
 test_expect_success 'unrelated submodule/file conflict is ignored' '
+	test_config_global protocol.file.allow always &&
+
 	test_create_repo sub &&
 
 	touch sub/file &&
Index: git-2.20.1/t/t3600-rm.sh
===================================================================
--- git-2.20.1.orig/t/t3600-rm.sh
+++ git-2.20.1/t/t3600-rm.sh
@@ -301,7 +301,7 @@ test_expect_success 'rm removes empty su
 
 test_expect_success 'rm removes removed submodule from index and .gitmodules' '
 	git reset --hard &&
-	git submodule update &&
+	git -c protocol.file.allow=always submodule update &&
 	rm -rf submod &&
 	git rm submod &&
 	git status -s -uno --ignore-submodules=none >actual &&
@@ -598,6 +598,7 @@ cat >expect.deepmodified <<EOF
 EOF
 
 test_expect_success 'setup subsubmodule' '
+	test_config_global protocol.file.allow always &&
 	git reset --hard &&
 	git submodule update &&
 	(cd submod &&
